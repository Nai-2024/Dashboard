// Core of backend communication

import { BASE_URL } from "../config";
import { logActivity } from "./activityService";

// Fetch all cities
export async function fetchCities() {
  const response = await fetch(`${BASE_URL}/api/cities`);
  if (!response.ok) throw new Error("Failed to fetch cities");
  const data = await response.json();

  return data.map((city) => ({
    _id: city._id,
    cityName: city.name || city.city,
    country: city.country || "Canada",
    description: city.description || `${city.city}, ${city.country}`,
    image: city.profile,
  }));
}

// Create a new city
export async function createCity(cityData) {
  const formData = new FormData();
  formData.append("name", cityData.cityName); // backend expects "name"
  formData.append("city", cityData.cityName); // also include "city"
  formData.append("country", cityData.country);
  formData.append("description", cityData.description);

  // if uploading actual file in the form of image
  if (cityData.image instanceof File) {
    formData.append("profile", cityData.image);
  }

  const response = await fetch(`${BASE_URL}/api/cities`, {
    method: "POST",
    body: formData,
  });

  if (!response.ok) throw new Error("Failed to add city");
  const data = await response.json();
  logActivity("Added", "City", cityData.cityName || cityData.name);
  return data;
}

// Update existing city
export async function updateCity(id, cityData) {
  console.log("No update endpoint found. Recreating city instead…");

  // Step 1 — Delete old city if it exists
  try {
    await deleteCity(id, cityData);
    console.log("Old city deleted:", id);
  } catch (err) {
    console.warn("City delete failed (may not exist):", err.message);
  }

  // Step 2 — Create new city with updated data
  const newCity = await createCity(cityData);

  // Log as "Updated" instead of "Added"
  logActivity("Updated", "City", cityData.cityName || cityData.name);

  console.log("City re-created:", newCity);

  // Refresh dashboard instantly
  window.dispatchEvent(new Event("activityUpdated"));

  return newCity;
}


// Delete a city
export async function deleteCity(id, cityData = {}) {
  const res = await fetch(`${BASE_URL}/api/cities/${id}`, { method: "DELETE" });

  if (res.status === 404) {
    console.warn(`City not found (ID: ${id})`);
    return null;
  }

  if (!res.ok) {
    const text = await res.text();
    console.error("Delete failed:", res.status, text);
    throw new Error("Failed to delete city");
  }

  const data = await res.json();

  // Determine the name intelligently
  const name =
    cityData?.cityName ||
    cityData?.name ||
    data?.name ||
    data?.city ||
    id ||
    "Unknown";

  logActivity("Deleted", "City", name);

  // Instantly refresh dashboard activities (no manual reload)
  window.dispatchEvent(new Event("activityUpdated"));

  return data;
}


// =========== Places ================ //

// Fetch all places
export async function fetchPlaces() {
  const res = await fetch(`${BASE_URL}/api/places`);
  if (!res.ok) throw new Error("Failed to fetch places");
  return await res.json();
}

// This function just talks to the server. Sends an HTTP POST request to /api/places.
export async function createPlace(placeData) {
  const formData = new FormData();

  formData.append("name", placeData.name);
  formData.append("category", placeData.category);
  formData.append("address", placeData.address);
  formData.append("city", placeData.city);
  formData.append("state", placeData.state);
  formData.append("country", placeData.country);
  formData.append("postalCode", placeData.postalCode);
  //formData.append("features", placeData.features);
  formData.append("certification", placeData.certification);
  formData.append("description", placeData.description);
  formData.append("phoneNumber", placeData.phoneNumber);
  formData.append("email", placeData.email);
  formData.append("website", placeData.website || "");
  formData.append("reviewLink", placeData.reviewLink || "");

  // Handle both single and multiple features
  if (typeof placeData.features === "string") {
    const featuresArray = placeData.features
      .split(",")
      .map((f) => f.trim())
      .filter((f) => f);
    formData.append("features", JSON.stringify(featuresArray));
  } else {
    formData.append("features", JSON.stringify(placeData.features || []));
  }

  // profile image
  if (placeData.profileImage instanceof File) {
    formData.append("profile", placeData.profileImage);
  }

  const res = await fetch(`${BASE_URL}/api/places`, {
    method: "POST",
    body: formData,
  });

  if (!res.ok) {
    const errorText = await res.text();
    console.error("Server response:", errorText);
    throw new Error("Failed to add place");
  }

  const data = await res.json();
  logActivity("Added", "Place", placeData.placeName || placeData.name);
  return data;
}

// Update existing place
export async function updatePlace(id, placeData) {
  console.log("Updating place with ID:", id);

  const formData = new FormData();

  formData.append("name", placeData.name);
  formData.append("category", placeData.category);
  formData.append("city", placeData.city);
  formData.append("state", placeData.state);
  formData.append("country", placeData.country);
  formData.append("postalCode", placeData.postalCode);
  formData.append("address", placeData.address);
  formData.append("certification", placeData.certification);
  formData.append("description", placeData.description);
  formData.append("phoneNumber", placeData.phoneNumber);
  formData.append("email", placeData.email);
  formData.append("website", placeData.website || "");
  formData.append("reviewLink", placeData.reviewLink || "");

  // Handle both single and multiple features
  if (typeof placeData.features === "string") {
    const featuresArray = placeData.features
      .split(",")
      .map((f) => f.trim())
      .filter((f) => f);
    formData.append("features", JSON.stringify(featuresArray));
  } else {
    formData.append("features", JSON.stringify(placeData.features || []));
  }
  //image update
  if (placeData.profileImage instanceof File) {
    formData.append("profile", placeData.profileImage);
  }

  const res = await fetch(`${BASE_URL}/api/places/${id}`, {
    method: "PUT",
    body: formData,
  });

  if (!res.ok) {
    const errorText = await res.text();
    console.error("Update failed:", res.status, errorText);
    throw new Error("Failed to update place");
  }

  const data = await res.json();

  logActivity("Updated", "Place", placeData.name || "Unknown");

  // Instantly tell dashboard to refresh
  window.dispatchEvent(new Event("activityUpdated"));

  return data;
}

// Delete a place
export async function deletePlace(id, placeData) {
  const res = await fetch(`${BASE_URL}/api/places/${id}`, {
    method: "DELETE",
  });

  if (res.status === 404) {
    console.warn(`Place not found (ID: ${id})`);
    return null;
  }

  if (!res.ok) {
    const text = await res.text();
    console.error("Delete failed:", res.status, text);
    throw new Error("Failed to delete place");
  }

  const data = await res.json();

  // Log with correct name
  logActivity("Deleted", "Place", placeData.name || "Unknown");

  // Instantly tell Dashboard to refresh
  window.dispatchEvent(new Event("activityUpdated"));

  return data;
}

// ========= Categories ============ //

// Fetch categories
export async function fetchCategories() {
  const res = await fetch(`${BASE_URL}/api/categories`);
  if (!res.ok) throw new Error("Failed to fetch categories");
  const data = await res.json();

  return data.map((cat) => ({
    _id: cat._id,
    name: cat.name,
    description: cat.description || "",
  }));
}

// ============ Fetcher user  =========== //
export async function fetchUsers() {
  try {
    const response = await fetch(`${BASE_URL}/api/users`);
    if (!response.ok) {
      throw new Error("Failed to fetch users");
    }
    const data = await response.json();
    return data; // expected array of users
  } catch (error) {
    console.error("Error fetching users:", error);
    throw error;
  }
}

// ============ Notification =========== //

// Fetch all notifications
export async function fetchNotifications() {
  const res = await fetch(`${BASE_URL}/notifications`);
  if (!res.ok) throw new Error("Failed to fetch notifications");
  return res.json();
}

// Add new notification
export async function createNotification(data) {
  const res = await fetch(`${BASE_URL}/notifications`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data),
  });
  if (!res.ok) throw new Error("Failed to create notification");
  return res.json();
}

// Delete a notification
export async function deleteNotification(id) {
  const res = await fetch(`${BASE_URL}/notifications/${id}`, {
    method: "DELETE",
  });
  if (!res.ok) throw new Error("Failed to delete notification");
  return res.json();
}

// =========== Google Map========= //
export async function geocodeCity(cityName, country) {
  try {
    const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(
      cityName
    )}&count=1&language=en&format=json`;

    const res = await fetch(url);
    if (!res.ok) throw new Error("Failed to fetch coordinates");

    const data = await res.json();

    if (data && data.results && data.results.length > 0) {
      const result = data.results[0];
      return {
        latitude: result.latitude,
        longitude: result.longitude,
      };
    } else {
      console.warn("No coordinates found for:", cityName, country);
    }
  } catch (err) {
    console.error("Geocoding failed:", err);
  }

  return null;
}
